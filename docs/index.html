<html>
    <head>
        <meta charset="utf-8">
        <title>チャットサイト</title>
        <link href="style.css" rel="stylesheet">
    </head>
    <body>
        <strong><div id="helloID"></div></strong>
        <div class="chat-box" id="chat-box" name="talkpage"></div>
        <textarea id="MessageText" class="MessageText" placeholder="メッセージを入力..." name="talkpage"></textarea>
        <p id="roomDetail" name="talkpage">あなたは現在公開ルームに参加しています。</p>
        <br><input type="text" placeholder="ルーム番号を入力してください(1-10文字)" id="roomID" name="talkpage"><button class="join" id="join" name="talkpage">参加</button>
        <h1 id="TalkingSite" name="startpage">トークサイト</h1> 
        <input type="text" class="userName" placeholder="ユーザー名を入力してください(3-10文字)" name="startpage" id="userName">
        <button id="TalkingStart" name="startpage">トークを始める</button>
        <script type="module">
//インポートするための文
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
            import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved, onValue , onChildChanged} from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js"; // 追加
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
          
            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
              apiKey: "AIzaSyALbxISZQW6hx97fFEOH7YkSPHZkHNwq6Y",
              authDomain: "test-6aa38.firebaseapp.com",
              databaseURL: "https://test-6aa38-default-rtdb.asia-southeast1.firebasedatabase.app",
              projectId: "test-6aa38",
              storageBucket: "test-6aa38.firebasestorage.app",
              messagingSenderId: "327819738458",
              appId: "1:327819738458:web:c04cc599a731e1aa238763",
              measurementId: "G-QXNG59XZES"
            };
          
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const db = getDatabase(app);

//実際の処理を記述↓↓
const EnteruserName = document.querySelector('[id="userName"]');
const privateroomID = document.querySelector(`[id="roomID"]`)
let year,month,day,hours,minutes,seconds,userName,progress,ToroomID,privateroom;
let messageroom = ref(db, 'chatsite/message/publicroom');//MSGを保存するルーム
let count = 0;

//スタートページのボタンが押されたら呼び出される関数
function StartClick(){
    userName = document.getElementById('userName').value;
    if(3 <= userName.length && userName.length <= 10 ){
        let StartPages = document.querySelectorAll('[name="startpage"]');
        wait();

        // 取得した要素を非表示にする
        StartPages.forEach(function(StartPage) {
        StartPage.style.display = "none";
        progress="Publicroom";
        TalkStart();
        });
    }
    else if(userName.length < 3){
        alert("ユーザネームが短すぎます。")
    }
    else if(userName.length > 10){
        alert("ユーザーネームが長すぎます。")
    }
}

//ユーザーネームが登録されトークが始まるときに呼び出される関数
function TalkStart(){
    document.getElementById("helloID").textContent = `ようこそ${userName}さん`;
    // name属性が'talkpage'の要素をすべて取得
    let TalkPages = document.querySelectorAll('[name="talkpage"]');

    // 各要素のdisplayを'block'にして表示
    TalkPages.forEach(function(TalkPage) {
        TalkPage.style.display = 'block';
    });
}

function wait(){
        //MSG受信処理
        onChildAdded(messageroom, function (snapshot) {
            if(progress==="Publicroom"){
            let data = snapshot.val();
            let chatbox = document.getElementById('chat-box');
            if (data.Name !== undefined && data.Text !== undefined && data.Type == "MSG"){
                let msg = `<${data.Name}> ${data.Text} ${data.Year}/${data.Month}/${data.Day}/${data.Hours}:${data.Minutes}:${data.Seconds}`;
                chatbox.appendChild(document.createTextNode(msg));
                chatbox.appendChild(document.createElement('br'));
            }
            }
        });
}

EnteruserName.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
        StartClick();
    }
});

privateroomID.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
        join();
    }
});

// textarea 要素を取得
const MessageText = document.getElementById("MessageText");

// Enter キーが押されたときの処理
MessageText.addEventListener("keydown", function(event) {
    // Shift が押されていない Enter キーを押した場合、改行を防止
    if (event.key === "Enter" && !event.shiftKey) {
        sendMessage();
        event.preventDefault();  // Enter キーのデフォルト動作（改行）をキャンセル
    }
});

function sendMessage(){
    updatatime();
    const text = document.getElementById('MessageText').value;
    if(progress==="Publicroom"){
    push(messageroom, {Name:userName, Type:"MSG", Text:text, Year:year, Month:month, Day:day, Hours:hours, Minutes:minutes, Seconds:seconds});
    }
    else if(progress==="Privateroom"){
    console.log(ToroomID);
    let privateroom = ref(db, 'chatsite/message/privateroom/' + ToroomID);//MSGを保存するルーム
    push(privateroom, {Name:userName, Type:"MSG", Text:text, Year:year, Month:month, Day:day, Hours:hours, Minutes:minutes, Seconds:seconds});
}
    document.getElementById('MessageText').value = '';
}

//時間を更新する関数
function updatatime(){
    const currentDate = new Date();
    year = currentDate.getFullYear();  //西暦
    month = currentDate.getMonth() + 1;  //月 
    day = currentDate.getDate();  //日
    hours = currentDate.getHours();  //時間
    minutes = currentDate.getMinutes();  //分
    seconds = currentDate.getSeconds();  //秒
}

function join(){
    count++;
    let i = count;
    ToroomID = document.getElementById('roomID').value;
    ToroomID = ToroomID.toString();
    console.log(ToroomID);
    if(1 <= ToroomID.length && ToroomID.length <= 10){
        privateroom = ref(db, 'chatsite/message/privateroom/' + ToroomID);//MSGを保存するルーム
        document.getElementById('roomID').value = '';
        document.getElementById("chat-box").textContent = ``;
        document.getElementById('roomDetail').innerHTML = `あなたは現在 ${ToroomID} ルームに参加しています。`;
        progress="Privateroom"
        //MSG受信処理
        onChildAdded(privateroom, function (snapshot) {
        if(progress==="Privateroom" && count <= i){
        let data = snapshot.val();
        let chatbox = document.getElementById('chat-box');
        if (data.Name !== undefined && data.Text !== undefined && data.Type == "MSG"){
        let msg = `<${data.Name}> ${data.Text} ${data.Year}/${data.Month}/${data.Day}/${data.Hours}:${data.Minutes}:${data.Seconds}`;
                chatbox.appendChild(document.createTextNode(msg));
                chatbox.appendChild(document.createElement('br'));
            }
            }
        });
    }
    else if(ToroomID.length < 1){
        alert("ルームIDが短すぎます。")
    }
    else if(ToroomID.length > 10){
        alert("ルームIDが長すぎます。")
    }
}

document.getElementById("TalkingStart").addEventListener("click", StartClick);
document.getElementById("join").addEventListener("click", join);
</script>
    </body>
</html>
