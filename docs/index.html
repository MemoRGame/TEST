<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>チャットテストサイト</title>
</head>
<body>
  <input id="name" type="text" value="" placeholder="名前"/><br>
  <input id="msg" type="text" value="" placeholder="メッセージ"/> 
  <button id="send" type="button" onclick="sendChat()">送信</button>
  <div id="MSG"></div>
</body>
<script>
ws = new WebSocket("wss://cloud.achex.ca/chsite");
var Name = Math.random().toString(32).substring(2);
let array = [];
let user = 0;
	
//メッセージを受信
ws.onmessage = e => {
	var obj = JSON.parse(e.data);
	if (obj.message == "login") {
		array.push(Name);
		ws.send(JSON.stringify({"to": "testactive", "message": "returnIN", "array": array}));
	}else if(obj.message == "returnIN"){
		user = user + 1;
                totaluser = array.length
		console.log("user:" + user + " totaluser:" + totaluser)
		checkAllUsersProcessed();
	}
}

function checkAllUsersProcessed() {
    if (user === totaluser) {
        console.log(user);  // ユーザー数が全員分処理された時に一度だけ表示
    }
}

//サーバー起動時
ws.onopen = e => {
	ws.send(JSON.stringify({"auth": "testactive", "password": "1234"}));
	ws.send(JSON.stringify({"to": "testactive", "message": "login"}));
}

//切断時
ws.onclosed = e => {
console.log('closed');
}
</script>
</html>
